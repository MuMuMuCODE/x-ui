name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v1.0.0)'
        required: true
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Prepare bin directory
        run: mkdir -p bin

      - name: Check xray binary
        id: check_xray
        run: |
          if [ -f "bin/xray-linux-${{ matrix.arch }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "xray binary found locally"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "xray binary not found, will download"
          fi

      - name: Download xray binary
        if: steps.check_xray.outputs.exists == 'false'
        run: |
          xray_version="1.8.4"
          echo "Downloading xray ${xray_version} for ${{ matrix.arch }}..."
          cd /tmp
          wget -q "https://github.com/XTLS/Xray-core/releases/download/v${xray_version}/Xray-linux-${{ matrix.arch }}.zip"
          unzip -o "Xray-linux-${{ matrix.arch }}.zip"
          mv xray /home/runner/work/x-ui/x-ui/bin/xray-linux-${{ matrix.arch }}
          chmod +x /home/runner/work/x-ui/x-ui/bin/xray-linux-${{ matrix.arch }}
          cd /home/runner/work/x-ui/x-ui

      - name: Verify xray binary
        run: |
          if [ ! -f "bin/xray-linux-${{ matrix.arch }}" ]; then
            echo "Error: xray binary not found after download attempts"
            exit 1
          fi
          echo "xray binary verified: $(ls -lh bin/xray-linux-${{ matrix.arch }})"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Register QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all
      
      - name: Build binary using Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace ubuntu:18.04 /bin/bash -lc "
            set -e
            apt-get update
            apt-get install -y wget git gcc g++ make gcc-aarch64-linux-gnu
            wget -q https://go.dev/dl/go1.21.5.linux-amd64.tar.gz
            rm -rf /usr/local/go
            tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz
            rm go1.21.5.linux-amd64.tar.gz
            export PATH=/usr/local/go/bin:\$PATH
            export GOPATH=/tmp/gopath
            export GO111MODULE=on
            cd /workspace
            mkdir -p /tmp/gopath
            export GOCACHE=/tmp/gocache
            if [ \"${{ matrix.arch }}\" = \"arm64\" ]; then export CC=aarch64-linux-gnu-gcc; else export CC=gcc; fi
            CGO_ENABLED=1 GOOS=linux GOARCH=${{ matrix.arch }} \
              go build -ldflags='-linkmode=external -s -w' \
              -o x-ui-${{ matrix.arch }} main.go
            echo 'Build completed'
          "

      - name: Verify binary
        run: |
          if [ ! -f "x-ui-${{ matrix.arch }}" ]; then
            echo "Error: binary not found after build"
            exit 1
          fi
          echo "Binary created: $(ls -lh x-ui-${{ matrix.arch }})"
          file x-ui-${{ matrix.arch }}

      - name: Prepare release files
        run: |
          mkdir -p release-package/bin
          
          # 复制 x-ui 主程序
          cp x-ui-${{ matrix.arch }} release-package/x-ui
          
          # 复制 xray 二进制文件（保留架构后缀）
          cp bin/xray-linux-${{ matrix.arch }} release-package/bin/xray-linux-${{ matrix.arch }}
          
          # 复制 geo 数据文件
          cp bin/geoip.dat release-package/
          cp bin/geosite.dat release-package/
          
          # 复制 web 目录
          cp -r web release-package/
          
          # 复制配置文件
          cp -r config release-package/
          
          # 复制数据库文件
          cp -r database release-package/
          
          # 复制工具目录
          cp -r util release-package/
          
          # 复制日志目录
          cp -r logger release-package/
          
          # 复制 v2ui 目录
          cp -r v2ui release-package/
          
          # 复制 xray 目录
          cp -r xray release-package/
          
          # 复制服务文件
          cp x-ui.service release-package/
          
          # 复制管理脚本
          cp x-ui.sh release-package/
          
          # 复制 LICENSE 和 README
          cp LICENSE release-package/
          cp README.md release-package/

      - name: Create tarball
        run: |
          cd release-package
          tar -czvf ../x-ui-linux-${{ matrix.arch }}.tar.gz *

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: x-ui-${{ matrix.arch }}
          path: x-ui-linux-${{ matrix.arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: x-ui ${{ steps.version.outputs.VERSION }}
          body: |
            ## Installation
            ```bash
            bash <(curl -Ls https://raw.githubusercontent.com/${{ github.repository }}/main/install_custom.sh) ${{ steps.version.outputs.VERSION }}
            ```
            
            Auto-built version for amd64 and arm64 architectures.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Print download links
        run: |
          echo "## Build Complete!"
          echo ""
          echo "**Version**: ${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "**Download Links**:"
          echo "- [x-ui-linux-amd64-${{ steps.version.outputs.VERSION }}.tar.gz](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }})"
          echo "- [x-ui-linux-arm64-${{ steps.version.outputs.VERSION }}.tar.gz](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }})"
          echo ""
          echo "**One-click Install Command**:"
          echo "```bash"
          echo "bash <(curl -Ls https://raw.githubusercontent.com/${{ github.repository }}/main/install_custom.sh) ${{ steps.version.outputs.VERSION }}"
          echo "```"
